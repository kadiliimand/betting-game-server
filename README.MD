# Betting Game Server ğŸ²
A simple multiplayer betting game implemented with Spring Boot and WebSockets.  
Players connect via REST and WebSocket APIs to place bets and receive real-time game updates.

## ğŸ® Game Rules
- The server starts a round with a configurable betting window (default: 10 seconds).
- Players place bets on numbers **1â€“10** with an amount.
- When the round closes, the server picks a random winning number.
- **Payouts are 9.9Ã— the stake** for correct guesses.
- All players receive a `WINNERS` broadcast message with the list of winners.
- Each player also gets a private `YOUR_RESULT` message:
    - `"WIN"` with payout amount
    - `"LOSE"` with payout = `0`
- The process repeats automatically if `game.auto-repeat=true`.

## âš™ï¸ Technology
- **Java 17+**
- **Spring Boot**
- **WebSocket API**
- **Gradle**
- **Awaitility** for async test waits
- **JUnit 5 & Mockito** for unit/integration tests

## ğŸ“¡ API Overview
### REST Endpoints
- `POST /api/rounds/start` â€“ Start new round
- `GET /api/rounds/current` â€“ Current round info
- `POST /api/bets` â€“ Place bet
  ```json
  { "nickname": "Joe", "number": 7, "amount": 10.00 }
  ```
- `GET /api/rounds/current` â€“ Current round info

### WebSocket Endpoint
- `ws://localhost:8080/ws/game`

### Incoming messages
```json
{ "type": "BET", "nickname": "Joe", "number": 7, "amount": 10.00 }
```

### Outgoing messages
```json
{ "type": "ROUND_OPENED", "roundId": 1, "closesAtMs": 1690001234567 }
{ "type": "ROUND_SETTLED", "roundId": 1, "winningNumber": 7 } 
{ "type": "WINNERS", "roundId": 1, "winners": [{ "nickname": "Joe", "winnings": 99.00 }] }
{ "type": "YOUR_RESULT", "roundId": 1, "result": "WIN", "payout": 99.00 }
{ "type": "BET_ACCEPTED" }
{ "type": "ROUND_CLOSED" | "DUPLICATE" | "INVALID" | "VALIDATION" | "BAD_JSON", "message": "..." }
```

## ğŸ§ª Testing
The project comes with comprehensive test coverage (~100%):
- `Service layer`
- `GameServiceTest` â€“ Round lifecycle, betting validation
- `GameServiceIntegTest` â€“ Integration with scheduler
- `GameServiceAutoRepeatTest` â€“ Auto-repeat rounds
- `Controller layer`
- `GameControllerIntegTest` â€“ REST endpoint integration
- `WebSocket layer`
- `GameWebSocketHandlerTest` â€“ Unit tests for handler branches (valid bet, invalid bet, duplicate, JSON errors, events, cleanup)
- `GameWebSocketIntegTest` â€“ End-to-end WebSocket lifecycle & message flow
- `Bootstrap`
- `BettingGameServerApplicationTests` â€“ Application context loads

## ğŸ“– Project Structure
### Main
```
src/main/java/com/liimand/bettinggameserver
â”œâ”€â”€ config          # GameConfig, WebSocketConfig, ApiExceptionHandler
â”œâ”€â”€ controller      # REST API endpoints
â”œâ”€â”€ domain          # Bet, RoundInfo, Settlement, WinnerInfo, RoundState, PlaceBetResult
â”‚    â””â”€â”€ mapper     # Mappers: RoundInfoMapper, SettlementMapper
â”œâ”€â”€ dto             # DTOs: BetRequest, ErrorDto, RoundDto, SettlementDto
â”œâ”€â”€ service         # GameService, GameListener
â”œâ”€â”€ util            # utilities
â””â”€â”€ websocket       # GameWebSocketHandler
```

### Test
```
src/test/java/com/liimand/bettinggameserver
 â”œâ”€â”€ controller      # REST controller integration tests
 â”œâ”€â”€ service         # Unit & integration tests for GameService
 â””â”€â”€ websocket       # WebSocket unit & integration tests
```

## ğŸš€ Highlights
- **Simple architecture** â€“ service-driven game loop with listener-based event propagation
- **Reactive communication** â€“ REST for commands, WebSocket for real-time events
- **Full validation** â€“ invalid bets rejected both via REST and WebSocket
- **Tests-first approach** â€“ async scenarios handled with Awaitility
- **Near-100% coverage** â€“ confidence in game logic and message flows
